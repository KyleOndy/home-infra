#!/usr/bin/env bash
set -Eeuo pipefail
set -x
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"

src_dir="$1"
dst_dir="$2"

"$DIR/unmount_chroot" "$1"

# https://unix.stackexchange.com/a/112325
rsync_args=(
#--verbose
--archive
--one-file-system
--xattrs
--hard-links
--numeric-ids
--sparse
--acls
#--exclude "$src_dir/var/log/*"
)

sudo rsync "${rsync_args[@]}" "${src_dir}/" "$dst_dir"

set -x
mkdir -p "$dst_dir"/{proc,sys,dev}
sudo mount -t proc /proc "$dst_dir/proc/"
sudo mount --rbind --make-rslave /sys "$dst_dir/sys/"
sudo mount --rbind --make-rslave /dev "$dst_dir/dev/"

#me=$(whoami)
#sudo chown -R "$me" "$dst_dir"
