#!/usr/bin/env bash
set -Eeuo pipefail

src_dir="$1"
dst_dir="$2"

# just in case
mounts=(
"$1/proc"
"$1/sys"
"$1/dev"
)

for mount in "${mounts[@]}"; do
  mountpoint -q "$mount" && sudo umount "$mount"
done

# https://unix.stackexchange.com/a/112325
rsync_args=(
#--verbose
--archive
--one-file-system
--xattrs
--hard-links
--numeric-ids
--sparse
--acls
#--exclude "$src_dir/var/log/*"
)

sudo rsync "${rsync_args[@]}" "${src_dir}/" "$dst_dir"

mkdir -p "$dst_dir"/{proc,sys,dev}
sudo mount -t proc /proc "$dst_dir/proc/"
sudo mount --rbind /sys "$dst_dir/sys/"
sudo mount --rbind /dev "$dst_dir/dev/"

#me=$(whoami)
#sudo chown -R "$me" "$dst_dir"
