#!/usr/bin/env bash
set -Eeuo pipefail
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"

# this runs each module against a fresh chroot, the idea being that each module
# should be fully self contianed, installing whatever packages it needs. This test makes no promises about things working at runtime, this simply checks that the modules will install properly.

modules=$(fd --type=directory --max-depth=1 . "$DIR/../modules/")

src_chroot=$(mktemp -d)
"$DIR/generate_chroot" "$src_chroot"

errors=()
for module in $modules; do
  module_chroot=$(mktemp -d)
  "$DIR/copy_chroot" "$src_chroot" "$module_chroot"
  if "$DIR/provision_chroot" "$module_chroot" "${module}/install"; then
    errors+=("$(basename "$module")")
  fi
done

if [ ${#errors[@]} -ne 0 ]; then
  echo "The following modules had erros: ${errors[*]}"
  exit 1
fi
