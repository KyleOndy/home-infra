#!/usr/bin/env bash
set -Eeuo pipefail
set -x

# todo: I am just giving every script my consul encryption key. This is a
# pretty bad security issues, but I also control all the scripts running, so
# its not too terrible. I need to work out how to best propagate secrets into
# all the configuration files.

# shellcheck disable=SC2024
# deep breath. Stuff of madness or genious below. The goal here is to be able
# to write scripts in a normal way, refrencing files alongside or deeper in
# the file hiarchery. This way I don't need to heredoc every config file
# inline with a script. However, some of my "scripts" are still just text,
# hence having to check if this "script" lives under /prod/self/fd.
#
# I suppose there is some edge case where I actaully write a script under
# /prod/self/fd/ and it doesn't work as expeced?

# todo: tmpdir

chroot_dir="$1"
script="$2"
args=( "${@:3}" ) # could be empty
tmp_script_dir_in_chroot="/tmp/chroot-script"
script_dir=$(dirname "$script")
module_name=$(basename "$script_dir")
script_name=$(basename "$script")

if [ ${#args[@]} -eq 0 ]; then
  args_str="no args"
else
  args_str="the args '${args[*]}'"
fi
echo "Running '$script' with $args_str inside '$chroot_dir'"

# debug info
#echo "tmp_script_dir_in_chroot: $tmp_script_dir_in_chroot"
#echo "script: $script"
#echo "args: ${args[*]}"
#echo "script_dir: $script_dir"
#echo "module_name: $module_name"
#echo "script_name: $script_name"

mkdir -p "$chroot_dir/$tmp_script_dir_in_chroot"
if [[ "$script_dir" == "/dev/fd" ]]; then
  # copy just the text "script"
  module_name="inline"
  mkdir "$chroot_dir/$tmp_script_dir_in_chroot/$module_name"
  cp --dereference "$script" "$chroot_dir/$tmp_script_dir_in_chroot/$module_name/"
else
  # copy the whole module directory
  cp -r --dereference "$script_dir" "$chroot_dir/$tmp_script_dir_in_chroot/"
fi

sudo chroot "$chroot_dir" /usr/bin/env PATH=/usr/sbin:/usr/bin/:/bin:/sbin:/usr/local/bin bash "$tmp_script_dir_in_chroot/$module_name/$script_name" "${args[@]}"

rm -r "${chroot_dir:?}/$tmp_script_dir_in_chroot"
