#!/usr/bin/env bash
set -Eeuo pipefail

usage() {
  echo "$0 <chroot>"
  echo "    output: path to ramroot.tar.gz"
}

if [[ "$#" -ne 1 ]]; then
  usage
  exit 1
fi

chroot="$1"
# todo: pass this in
PIXZ_COMPRESSION_LEVEL=6

WORK_DIR=$(mktemp -d --tmpdir=/tmp debootstrap.package.XXXX)

pushd "$chroot" > /dev/null && {
  # todo: I feel like there should be an easier way to do this.
  sudo tar -cf "$WORK_DIR/ramroot.tar" .
}
popd > /dev/null

pixz "-$PIXZ_COMPRESSION_LEVEL" < "$WORK_DIR/ramroot.tar" > "$WORK_DIR/ramroot.tar.xz"
echo "$WORK_DIR/ramroot.tar.xz"
