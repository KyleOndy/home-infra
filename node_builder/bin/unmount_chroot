#!/usr/bin/env bash
set -Eeuo pipefail
set -x

chroot_dir="$1"

is_chroot_unmounted() {
  mount | rg --quiet "$chroot_dir"
  # there is probably a better wat to do this
  if $?; then
    return 1
  else
    return 0
  fi
}

#mounts=(
#"${chroot_dir}/proc"
#"${chroot_dir}/dev"
#"${chroot_dir}/sys"
#)
#
#for mount in "${mounts[@]}"; do
#  if mountpoint -q "$mount"; then sudo umount "$mount"; fi
#done

# bail early if things are looking good.
is_chroot_unmounted && exit 0

mount | rg "$chroot_dir" | cut -d' ' -f3 | xargs -r -L1 sudo umount --recursive

# check if eveything was unmounted correctly
is_chroot_unmounted && exit 0
exit 1
